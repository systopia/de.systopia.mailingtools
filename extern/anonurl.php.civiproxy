<?php
/*-------------------------------------------------------+
| SYSTOPIA Mailingtools Extension                        |
| Copyright (C) 2019 SYSTOPIA                            |
| Author: B. Endres (endres@systopia.de)                 |
+--------------------------------------------------------+
| This program is released as free software under the    |
| Affero GPL license. You can redistribute it and/or     |
| modify it under the terms of this license which you    |
| can read by viewing the included agpl.txt or online    |
| at www.gnu.org/licenses/agpl.html. Removal of this     |
| copyright header is strictly prohibited without        |
| written permission from the original author(s).        |
+--------------------------------------------------------*/

ini_set('include_path', dirname(dirname(__FILE__)));
require_once "proxy.php";

// see if mail click tracking is enabled
if (!$mail_subscription_user_key) civiproxy_http_error("Feature disabled", 405);

// basic check
civiproxy_security_check('mail-anonymous-link');

// basic restraints
$valid_parameters = array('u' => 'int');
$parameters = civiproxy_get_parameters($valid_parameters);

// check if parameters specified
if (empty($parameters['u'])) civiproxy_http_error("Missing/invalid parameter 'u'.");

// PERFORM Mailingtools.anonurl
try {
  $url_result = civicrm_api3('Mailingtools', 'anonurl', array(
      'u'       => $parameters['u'],
      'api_key' => $mail_subscription_user_key));

  // redirect user to the given URL
  $target_url = reset($url_result['values']);
  civiproxy_redirect($target_url, []);

} catch(Exception $ex) {
  // something's wrong:
  if (function_exists('civiproxy_log')) {
    civiproxy_log("Couldn't call Mailingtools.anonurl with u={$parameters['u']}");
  } else {
    error_log("Couldn't call Mailingtools.anonurl with u={$parameters['u']}");
  }
}



?>